<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Продукты</title>
    <style>
        #db { display: none; margin-top: 10px; }
        table { border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .nutrient-col { display: none; }
        .max-weight { padding: 2px 4px; }
    </style>
</head>
<body>
    <label><input type="checkbox" id="toggle-db"> Показать ДБ</label>
    <label><input type="checkbox" id="toggle-nutrients"> Показать КБЖУ+</label>
    <table id="db">
        <thead>
            <tr>
                <th>Выбрать</th>
                <th>Продукт</th>
                <th class="nutrient-col">Белки</th>
                <th class="nutrient-col">Насыщенные</th>
                <th class="nutrient-col">НЕнасыщенные</th>
                <th class="nutrient-col">Простые</th>
                <th class="nutrient-col">Сложные</th>
                <th class="nutrient-col">Растворимая</th>
                <th class="nutrient-col">Нерастворимая</th>
                <th class="nutrient-col">ККал</th>
                <th>Макс. порций</th>
                <th>Шаг</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <h2>Мой пул</h2>
    <table id="pool">
        <thead>
            <tr>
                <th>Продукт</th>
                <th class="nutrient-col">Белки</th>
                <th class="nutrient-col">Насыщенные</th>
                <th class="nutrient-col">НЕнасыщенные</th>
                <th class="nutrient-col">Простые</th>
                <th class="nutrient-col">Сложные</th>
                <th class="nutrient-col">Растворимая</th>
                <th class="nutrient-col">Нерастворимая</th>
                <th class="nutrient-col">ККал</th>
                <th>Макс. порций</th>
                <th>Шаг</th>
                <th>Допустимый вес Max.</th>
                <th>фикс. вес</th>
                <th>На оптимизацию</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const dbTable = document.getElementById('db');
        const dbBody = dbTable.querySelector('tbody');
        const poolTable = document.getElementById('pool');
        const poolBody = poolTable.querySelector('tbody');
        const products = {};
        const optimizationList = new Set();

        function updateNutrientVisibility() {
            const show = document.getElementById('toggle-nutrients').checked;
            document.querySelectorAll('.nutrient-col').forEach(cell => {
                cell.style.display = show ? 'table-cell' : 'none';
            });
        }

        document.getElementById('toggle-db').addEventListener('change', function() {
            dbTable.style.display = this.checked ? 'table' : 'none';
        });

        function addToPool(name) {
            const existing = document.querySelector('#pool tbody tr[data-name="' + name + '"]');
            if (!existing) {
                const data = products[name] || {};
                const tr = document.createElement('tr');
                tr.setAttribute('data-name', name);
                tr.innerHTML = `
                    <td>${name}</td>
                    <td class="nutrient-col">${data.proteins}</td>
                    <td class="nutrient-col">${data.saturated}</td>
                    <td class="nutrient-col">${data.unsaturated}</td>
                    <td class="nutrient-col">${data.simple}</td>
                    <td class="nutrient-col">${data.complex}</td>
                    <td class="nutrient-col">${data.soluble}</td>
                    <td class="nutrient-col">${data.insoluble}</td>
                    <td class="nutrient-col">${data.kcal}</td>
                    <td><input type="number" class="max-portions" min="0" step="1" value="${data.defaultMax || 0}"></td>
                    <td><input type="number" class="step" min="0" step="0.1" value="${data.defaultStep || 0}"></td>
                    <td class="max-weight"><span class="weight-value">0</span></td>
                    <td><input type="checkbox" class="fix-weight"></td>
                    <td><input type="checkbox" class="optimize"></td>
                `;
                poolBody.appendChild(tr);
                updateNutrientVisibility();

                const maxPortionsInput = tr.querySelector('.max-portions');
                const stepInput = tr.querySelector('.step');
                const weightValue = tr.querySelector('.weight-value');
                const fixCheckbox = tr.querySelector('.fix-weight');
                const maxWeightCell = tr.querySelector('.max-weight');
                const optimizeCheckbox = tr.querySelector('.optimize');

                function updateWeight() {
                    const maxPortions = parseFloat(maxPortionsInput.value) || 0;
                    const step = parseFloat(stepInput.value) || 0;
                    const weight = maxPortions * step;
                    weightValue.textContent = weight.toFixed(1);
                }

                maxPortionsInput.addEventListener('input', updateWeight);
                stepInput.addEventListener('input', updateWeight);
                updateWeight();

                fixCheckbox.addEventListener('change', function() {
                    maxWeightCell.style.backgroundColor = this.checked ? '#ffb6c1' : '';
                });

                optimizeCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        optimizationList.add(name);
                    } else {
                        optimizationList.delete(name);
                    }
                });
            }
        }

        function removeFromPool(name) {
            const tr = document.querySelector('#pool tbody tr[data-name="' + name + '"]');
            if (tr) {
                tr.remove();
            }
            optimizationList.delete(name);
        }

        fetch('Nutrients%20DB.csv')
            .then(response => response.text())
            .then(text => {
                const lines = text.trim().split(/\r?\n/);
                lines.splice(0, 2); // remove header lines
                lines.forEach(line => {
                    if (!line) return;
                    const cols = line.split(',');
                    const name = cols[0];
                    products[name] = {
                        proteins: parseFloat(cols[1]),
                        saturated: parseFloat(cols[2]),
                        unsaturated: parseFloat(cols[3]),
                        simple: parseFloat(cols[4]),
                        complex: parseFloat(cols[5]),
                        soluble: parseFloat(cols[6]),
                        insoluble: parseFloat(cols[7]),
                        kcal: parseFloat(cols[8]),
                        defaultMax: parseFloat(cols[9]),
                        defaultStep: parseFloat(cols[10])
                    };

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="checkbox" class="select-product"></td>
                        <td>${name}</td>
                        <td class="nutrient-col">${cols[1]}</td>
                        <td class="nutrient-col">${cols[2]}</td>
                        <td class="nutrient-col">${cols[3]}</td>
                        <td class="nutrient-col">${cols[4]}</td>
                        <td class="nutrient-col">${cols[5]}</td>
                        <td class="nutrient-col">${cols[6]}</td>
                        <td class="nutrient-col">${cols[7]}</td>
                        <td class="nutrient-col">${cols[8]}</td>
                        <td>${cols[9]}</td>
                        <td>${cols[10]}</td>
                    `;
                    dbBody.appendChild(tr);
                    updateNutrientVisibility();

                    const checkbox = tr.querySelector('.select-product');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            addToPool(name);
                        } else {
                            removeFromPool(name);
                        }
                    });
                });
            });

        document.getElementById('toggle-nutrients').addEventListener('change', updateNutrientVisibility);
    </script>
</body>
</html>
