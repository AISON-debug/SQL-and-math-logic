<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Продукты</title>
    <style>
        #db { display: none; margin-top: 10px; }
        #pool { margin-top: 10px; }
        label { display: block; }
        .nutrients { display: none; margin-left: 10px; font-size: 0.9em; }
        .max-weight { padding: 2px 4px; }
    </style>
</head>
<body>
    <label><input type="checkbox" id="toggle-db"> Показать ДБ</label>
    <label><input type="checkbox" id="toggle-nutrients"> Показать КБЖУ+</label>
    <div id="db"></div>
    <h2>Мой пул</h2>
    <ul id="pool"></ul>

    <script>
        const dbDiv = document.getElementById('db');
        const poolUl = document.getElementById('pool');
        const products = {};
        const optimizationList = new Set();

        document.getElementById('toggle-db').addEventListener('change', function() {
            dbDiv.style.display = this.checked ? 'block' : 'none';
        });

        function addToPool(name) {
            const existing = document.querySelector('#pool li[data-name="' + name + '"]');
            if (!existing) {
                const data = products[name] || {};
                const li = document.createElement('li');
                li.setAttribute('data-name', name);
                li.innerHTML = `
                    <span class="product-name">${name}</span>
                    <label> Макс. порций: <input type="number" class="max-portions" min="0" step="1" value="${data.defaultMax || 0}"></label>
                    <label> Шаг: <input type="number" class="step" min="0" step="0.1" value="${data.defaultStep || 0}"></label>
                    <span class="max-weight">Допустимый вес Max.: <span class="weight-value">0</span></span>
                    <label><input type="checkbox" class="fix-weight"> фиксировать вес</label>
                    <label><input type="checkbox" class="optimize"> На оптимизацию</label>
                `;
                poolUl.appendChild(li);

                const maxPortionsInput = li.querySelector('.max-portions');
                const stepInput = li.querySelector('.step');
                const weightValue = li.querySelector('.weight-value');
                const fixCheckbox = li.querySelector('.fix-weight');
                const maxWeightSpan = li.querySelector('.max-weight');
                const optimizeCheckbox = li.querySelector('.optimize');

                function updateWeight() {
                    const maxPortions = parseFloat(maxPortionsInput.value) || 0;
                    const step = parseFloat(stepInput.value) || 0;
                    const weight = maxPortions * step;
                    weightValue.textContent = weight.toFixed(1);
                }

                maxPortionsInput.addEventListener('input', updateWeight);
                stepInput.addEventListener('input', updateWeight);
                updateWeight();

                fixCheckbox.addEventListener('change', function() {
                    maxWeightSpan.style.backgroundColor = this.checked ? '#ffb6c1' : '';
                });

                optimizeCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        optimizationList.add(name);
                    } else {
                        optimizationList.delete(name);
                    }
                });
            }
        }

        function removeFromPool(name) {
            const li = document.querySelector('#pool li[data-name="' + name + '"]');
            if (li) {
                li.remove();
            }
            optimizationList.delete(name);
        }

        fetch('Nutrients%20DB.csv')
            .then(response => response.text())
            .then(text => {
                const lines = text.trim().split(/\r?\n/);
                lines.splice(0, 2); // remove header lines
                lines.forEach(line => {
                    if (!line) return;
                    const cols = line.split(',');
                    const name = cols[0];
                    products[name] = {
                        proteins: parseFloat(cols[1]),
                        saturated: parseFloat(cols[2]),
                        unsaturated: parseFloat(cols[3]),
                        simple: parseFloat(cols[4]),
                        complex: parseFloat(cols[5]),
                        soluble: parseFloat(cols[6]),
                        insoluble: parseFloat(cols[7]),
                        kcal: parseFloat(cols[8]),
                        defaultMax: parseFloat(cols[9]),
                        defaultStep: parseFloat(cols[10])
                    };

                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            addToPool(name);
                        } else {
                            removeFromPool(name);
                        }
                    });
                    const nutrientSpan = document.createElement('span');
                    nutrientSpan.className = 'nutrients';
                    nutrientSpan.textContent = ` Б:${cols[1]} Жн:${cols[2]} Жнн:${cols[3]} Пр:${cols[4]} Сл:${cols[5]} Раств:${cols[6]} Нер:${cols[7]} ККал:${cols[8]}`;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + name));
                    label.appendChild(nutrientSpan);
                    dbDiv.appendChild(label);
                });
            });

        document.getElementById('toggle-nutrients').addEventListener('change', function() {
            document.querySelectorAll('.nutrients').forEach(span => {
                span.style.display = this.checked ? 'inline' : 'none';
            });
        });
    </script>
</body>
</html>
